name: Release

on:
  release:
    types: [published]

permissions:
  contents: read
  id-token: write  # For OIDC token for NuGet trusted publishing (optional)

# Prevent concurrent releases
concurrency:
  group: release-${{ github.ref }}
  cancel-in-progress: false

jobs:
  # Verify CI passed before releasing
  verify-ci:
    runs-on: ubuntu-latest
    outputs:
      should-release: ${{ steps.check.outputs.should-release }}

    steps:
      - name: Check release is from main branch
        id: check
        run: |
          # Only allow releases from main branch
          if [[ "${{ github.event.release.target_commitish }}" == "main" ]]; then
            echo "should-release=true" >> $GITHUB_OUTPUT
            echo "âœ… Release is from main branch"
          else
            echo "should-release=false" >> $GITHUB_OUTPUT
            echo "âŒ Release must be from main branch, got: ${{ github.event.release.target_commitish }}"
            exit 1
          fi

  # Run full CI before publishing
  ci:
    needs: verify-ci
    runs-on: ubuntu-latest

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Test
        run: dotnet test --no-build --configuration Release --verbosity normal

  # Publish to NuGet.org
  publish:
    needs: ci
    runs-on: ubuntu-latest
    environment: release

    steps:
      - uses: actions/checkout@v4

      - name: Setup .NET
        uses: actions/setup-dotnet@v4
        with:
          dotnet-version: |
            6.0.x
            7.0.x
            8.0.x
            9.0.x
            10.0.x

      - name: Restore dependencies
        run: dotnet restore

      - name: Build
        run: dotnet build --no-restore --configuration Release

      - name: Extract version
        id: version
        run: |
          TAG="${{ github.event.release.tag_name }}"
          VERSION="${TAG#v}"
          echo "VERSION=$VERSION" >> $GITHUB_OUTPUT
          echo "Extracted version: $VERSION (from tag: $TAG)"

      - name: Pack with release version
        run: |
          dotnet pack src/ErrorLens.ErrorHandling/ErrorLens.ErrorHandling.csproj --configuration Release --output ./artifacts /p:Version=${{ steps.version.outputs.VERSION }}
          dotnet pack src/ErrorLens.ErrorHandling.OpenApi/ErrorLens.ErrorHandling.OpenApi.csproj --configuration Release --output ./artifacts /p:Version=${{ steps.version.outputs.VERSION }}
          dotnet pack src/ErrorLens.ErrorHandling.Swashbuckle/ErrorLens.ErrorHandling.Swashbuckle.csproj --configuration Release --output ./artifacts /p:Version=${{ steps.version.outputs.VERSION }}
          dotnet pack src/ErrorLens.ErrorHandling.FluentValidation/ErrorLens.ErrorHandling.FluentValidation.csproj --configuration Release --output ./artifacts /p:Version=${{ steps.version.outputs.VERSION }}

      - name: Display package info
        run: |
          echo "ðŸ“¦ Package created:"
          ls -la ./artifacts/
          echo "Version: ${{ steps.version.outputs.VERSION }}"

      - name: Push to NuGet.org
        run: dotnet nuget push ./artifacts/*.nupkg --api-key ${{ secrets.NUGET_API_KEY }} --source https://api.nuget.org/v3/index.json --skip-duplicate

      - name: Summary
        run: |
          echo "## Release Published" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "- **Version:** ${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ErrorLens.ErrorHandling:** https://www.nuget.org/packages/ErrorLens.ErrorHandling/${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ErrorLens.ErrorHandling.OpenApi:** https://www.nuget.org/packages/ErrorLens.ErrorHandling.OpenApi/${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ErrorLens.ErrorHandling.Swashbuckle:** https://www.nuget.org/packages/ErrorLens.ErrorHandling.Swashbuckle/${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
          echo "- **ErrorLens.ErrorHandling.FluentValidation:** https://www.nuget.org/packages/ErrorLens.ErrorHandling.FluentValidation/${{ steps.version.outputs.VERSION }}" >> $GITHUB_STEP_SUMMARY
